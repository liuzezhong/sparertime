<!DOCTYPE html><html lang="zh"><head><title>浏览器安全策略 CSP 部署：Teambition 实战 - Teambition</title><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="keywords" content="团队协作工具,团队管理工具,项目管理工具,项目协作工具,任务分配,任务进度,文件存储,文件共享,在线预览,知识管理,日程管理,项目管理,项目讨论,项目沟通"><meta name="description" content="Teambition 是一个简单，高效的项目协作工具，你可以在这里管理项目，跟踪任务进度，存储项目文件，让你的团队协作更高效。"><meta property="og:description" content="Teambition 对于安全问题一直非常关注，前一阵子@严清老师郑重提出必须即时部署 CSP，然后大家一起认真琢磨了一下，觉得确实是应该在社区中推广的安全策略，特别是 Teambition 的合作伙伴们＝）。下文是严清撰写的实战经验，供大家参考。"><meta name="viewport" content="initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta name="apple-itunes-app" content="app-id=656664814"/><link rel="alternate" href="../../../site/404.html" hreflang="x-default" /><link rel="shortcut icon" href="../../../favicon.ico"><link rel="stylesheet" href="https://dn-st.teambition.net/site/v2.0.0/css/lib.fc2b25bd.css"><link rel="stylesheet" href="https://dn-st.teambition.net/site/v2.0.0/css/app.f8bcf230.css"></head><body class="page-developer-article tbsite-article zh"><header class="site-header "><div class="container"><nav class="navbar" role="navigation"><div class="navbar-header"><button class="btn btn-primary navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">菜单</button><a class="navbar-brand" href="../../index.html" data-gta="event" data-category="out-top-nav" data-action="tb logo">Teambition・最好用的团队协作工具</a></div><div class="collapse navbar-collapse"><div class="items-wrap"><ul class="navbar-button list-inline"><li class="switch-locale-wrap"><div class="dropdown switch-locale"><a class="dropdown-toggle zh">中文版</a><ul class="dropdown-menu" role="menu" aria-labelledby="dLabel"><li><a href="../../../tw/developer/blog/article-_id=5438e83ee903ca681810f174.html" class="tw">繁體版</a></li><li><a href="../../../en/developer/blog/article-_id=5438e83ee903ca681810f174.html" class="en">English</a></li><li><a href="../../../ko/developer/blog/article-_id=5438e83ee903ca681810f174.html" class="ko">한국어</a></li></ul></div></li><li><a class="btn btn-default btn-sm login" href="https://account.teambition.com/login" data-gta="event" data-category="out-top-nav" data-action="login">登录</a></li><li><a class="btn btn-default btn-sm signup" href="https://account.teambition.com/signup?from=nav" data-gta="event" data-category="out-top-nav" data-action="signup">免费注册</a></li></ul><ul class="nav navbar-nav"><li ><a href="../../tour.html" data-gta="event" data-category="out-top-nav" data-action="tour">功能</a></li><li ><a href="../../pricing.html" data-gta="event" data-category="out-top-nav" data-action="prices">价格</a></li><li ><a href="../../apps.html" data-gta="event" data-category="out-top-nav" data-action="apps">下载</a></li><li><a href="https://bbs.teambition.com" data-gta="event" data-category="out-top-nav" data-action="community">社区</a></li><li><a href="https://blog.teambition.com/zh" data-gta="event" data-category="out-top-nav" data-action="blog">博客</a></li></ul></div></div></nav></div></header><div class="site-main"><div class="article-content"><div class="topbanner not-image"  style="background-color: #494949;"><div class="bg-mask"><div class="container max1010"><div class="return"><a href="../blog.html"><span class="icon icon-chevron-left"></span>返回 创作随笔</a></div><h1 class="title">浏览器安全策略 CSP 部署：Teambition 实战</h1></div></div></div><div class="main-content readable"><div class="container max730"><blockquote>
<p><a href="../../../index.html">Teambition</a> 对于安全问题一直非常关注，前一阵子<a href="http://weibo.com/zensh">@严清</a>老师郑重提出必须即时部署 CSP, 然后大家一起认真琢磨了一下，觉得确实是应该在社区中推广的安全策略，特别是 Teambition 的合作伙伴们＝）。下文是严清撰写的实战经验，供大家参考。</p>
</blockquote>
<p>最早接触 CSP 还是 AngularJS 的 ng-csp 指令，但实际上一直没有真正理解，直到两个月前看了 @xisigr 的这篇文章：《浏览器安全策略说之内容安全策略CSP》，才发现 CSP 的确是一个出色的 WEB 安全方案。</p>
<p>简而言之，内容安全策略（Content Security Policy，简称 CSP）是一种以可信白名单作机制，来限制网站中是否可以包含某来源的资源。资源类型细分为 Script、Style、Image、Font、Connect、Media、Object、Frame 等，可分别配置其来源。默认配置下不允许执行内联脚本和内联样式，也禁止执行 eval。</p>
<p>这里我以 Teambition 实际部署过程讲解 CSP 部署，让大家有个感性的认识。</p>
<p><strong>CSP 规则讲解</strong></p>
<p>我们先来看 Teambition 平台网页的一段 Response Headers：</p>
<pre><code>content-encoding:gzip
content-security-policy:default-src https://*.teambition.com; script-src https://dn-st.oss.aliyuncs.com https://hm.baidu.com https://cdn.mxpnl.com https://www.google-analytics.com; style-src data: &#39;unsafe-inline&#39; https://dn-st.oss.aliyuncs.com; img-src data: blob: https://*.teambition.com https://dn-st.oss.aliyuncs.com https://dn-st.qbox.me https://hm.baidu.com https://www.google-analytics.com; frame-src https:; font-src https://dn-st.oss.aliyuncs.com; connect-src https://*.teambition.com wss://*.teambition.com https://api.mixpanel.com
content-type:text/html; charset=utf-8
date:Sat, 02 Aug 2014 10:41:10 GMT
server:nginx
status:200 OK
teambition:wv=release
version:HTTP/1.1
</code></pre><p>其中 content-security-policy 的内容就是我们设定的 CSP 规则，Response Headers 中还有 x-content-security-policy 和x-webkit-csp，内容一样，是为了做浏览器兼容。其中的 CSP 规则详细解释如下：</p>
<pre><code>default-src https://*.teambition.com;
</code></pre><p>default-src 默认规则，当相关资源未定义规则时，就使用默认规则，这里定义了只允许从 teambition.com 域及子域加载资源，并且必须是 https 安全链接。</p>
<pre><code>script-src https://dn-st.oss.aliyuncs.com https://hm.baidu.com https://cdn.mxpnl.com https://www.google-analytics.com;
</code></pre><p>script-src JS 脚本规则，这里只允许从阿里云、百度、mixpanel、google 的指定域下加载脚本，其中阿里云是 teambition 使用的 CDN，后三者是因为要加载统计脚本。另外，CSP 规则默认不允许执行內联 JS 脚本、eval、Function 等。最大程度的限制了非法 JS 脚本的运行。我们部署 CSP 的主要工作就是去除源码中的內联脚本。</p>
<pre><code>style-src data: &#39;unsafe-inline&#39; https://dn-st.oss.aliyuncs.com;
</code></pre><p>style-src CSS 样式规则，这里只允许从阿里云的指定域下加载 CSS，并且允许 data 和內联 CSS，CSP 规则默认不允许內联 CSS，但实际场景中，很多 UI 控制都依赖內联 CSS，尤其是网页动画。</p>
<pre><code>img-src data: blob: https://*.teambition.com https://dn-st.oss.aliyuncs.com https://dn-st.qbox.me https://hm.baidu.com https://www.google-analytics.com;
</code></pre><p>img-src img 规则，这里限制放得比较宽，其中还有百度和 google 的域，是因为他们的统计请求返回的是图片，如果禁了统计请求将失效。</p>
<pre><code>frame-src https:;
</code></pre><p>frame-src frame 规则，这里目前允许所有 https 链接。实际上 teambition 目前只使用了 dropbox 的组件。今后根据情况再调整。</p>
<pre><code>font-src https://dn-st.oss.aliyuncs.com;
</code></pre><p>font-src font 规则，同样只允许从阿里云加载。</p>
<pre><code>connect-src https://*.teambition.com wss://*.teambition.com https://api.mixpanel.com
</code></pre><p>connect-src connect 规则，包括 XMLHttpRequest、WebSocket 等链接。teambition 的消息推送就用了 WebSocket 链接。</p>
<p>另外还有 Object、Media 等未定义的就使用 default-src 规则。也还有一些 CSP 特性，如 report-uri 攻击报告等，这里不再阐述。</p>
<p><strong>CSP 后端部署</strong></p>
<p>Teambition 使用的 node.js 服务器，部署相当简单，相关代码端如下：</p>
<pre><code>if (config.CSP_HEADER) {
    res.set({
      &#39;Content-Security-Policy&#39;: config.CSP_HEADER,
      &#39;X-Content-Security-Policy&#39;: config.CSP_HEADER,
      &#39;X-WebKit-CSP&#39;: config.CSP_HEADER
    });
  }
</code></pre><p>也就是判断 CSP 规则是否存在，存在就将其设置到网页头部。这里之所以有这个判断，是因为 Teambition 存在开发环境、测试环境、线上环境和私有部署环境，不同环境配置了不同规则。</p>
<p><strong>CSP 部署的前端工作</strong></p>
<p>CSP 部署后端工作就是上面这段，无比简单，但真正的工作量却是在前端！</p>
<p>我们部署 CSP 最大目的就是禁止非法脚本运行，只允许从指定域加载脚本运行，其它域和內联脚本都应该禁止。我们的工作就是要去掉所有內联脚本。之前，Teambition 有两处用到了內联脚本。</p>
<p>一是全局变量 Teambition ：
    script
      (function () {
        window.teambition = {}
        teambition.apiHost = &#39;#{config.API_HOST}&#39;
        teambition.pushHost = &#39;#{config.PUSH_HOST}&#39;
        teambition.uploadUrl = &#39;#{config.FILE_HOST}&#39;
        teambition.loadingStart = Date.now()
      })()</p>
<p>这是为了方便从服务器获取初始化配置信息，以及其它的前端构架内部的各种方便～。为了部署 CSP 只好忍痛去除全局变量：）。从服务器获取初始配置信息变成了这样：</p>
<pre><code>script(id=&quot;teambition-global&quot;,
  data-apihost=&quot;#{config.API_HOST}&quot;,
  data-pushhost=&quot;#{config.PUSH_HOST}&quot;,
  data-uploadurl=&quot;#{config.FILE_HOST}&quot;,
  data-spiderhost=&quot;#{config.SPIDER_HOST}&quot;,
  data-responsetime=&quot;#{timestamp}&quot;)
</code></pre><p>当然，从三万行代码中去除全局变量不是这么简单，细节这里就不叙述了，加上修 BUG，花了我一整天，改完之后确实是舒服多了。</p>
<p>二是统计脚本：</p>
<p>前端朋友应该都知道如何嵌入百度、Google 等统计服务，没错，就是在网页中插入內联脚本。</p>
<p>Teambition 做了一个叫 GTA 的开源封装，将百度、Google 和 Mixpanel 三家统计分析服务融合到一起。去內联就是重构 GTA 模块，这里有一个要点，就是尽量提前（调用前）用 appKey 将它们初始化。具体重构就不细说了，请直接看代码。</p>
<p>最后，附送一个 CSP 规则生成器 <a href="http://cspisawesome.com/">http://cspisawesome.com/</a>，Teambition 的 CSP 规则是在这里生成的。</p>
</div></div><div class="article-toolbar text-center"><div class="share-button-group"><a href="http://service.weibo.com/share/share.php?ralateUid=2673498793&amp;url=https://www.teambition.com/developer/blog/article%3F_id=5438e83ee903ca681810f174%26p=weibo-share&amp;title=%E3%80%90%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%20CSP%20%E9%83%A8%E7%BD%B2%EF%BC%9ATeambition%20%E5%AE%9E%E6%88%98%E3%80%91Teambition%20%E5%AF%B9%E4%BA%8E%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E4%B8%80%E7%9B%B4%E9%9D%9E%E5%B8%B8%E5%85%B3%E6%B3%A8%EF%BC%8C%E5%89%8D%E4%B8%80%E9%98%B5%E5%AD%90@%E4%B8%A5%E6%B8%85%E8%80%81%E5%B8%88%E9%83%91%E9%87%8D%E6%8F%90%E5%87%BA%E5%BF%85%E9%A1%BB%E5%8D%B3%E6%97%B6%E9%83%A8%E7%BD%B2%20CSP%EF%BC%8C%E7%84%B6%E5%90%8E%E5%A4%A7%E5%AE%B6%E4%B8%80%E8%B5%B7%E8%AE%A4%E7%9C%9F%E7%90%A2%E7%A3%A8%E4%BA%86%E4%B8%80%E4%B8%8B%EF%BC%8C%E8%A7%89%E5%BE%97%E7%A1%AE%E5%AE%9E%E6%98%AF%E5%BA%94%E8%AF%A5%E5%9C%A8%E7%A4%BE%E5%8C%BA%E4%B8%AD%E6%8E%A8%E5%B9%BF%E7%9A%84%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%EF%BC%8C%E7%89%B9%E5%88%AB%E6%98%AF%20Teambition%20%E7%9A%84%E5%90%88%E4%BD%9C%E4%BC%99%E4%BC%B4%E4%BB%AC%EF%BC%9D%EF%BC%89%E3%80%82%E4%B8%8B%E6%96%87%E6%98%AF%E4%B8%A5%E6%B8%85%E6%92%B0%E5%86%99%E7%9A%84%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%EF%BC%8C%E4%BE%9B%E5%A4%A7%E5%AE%B6%E5%8F%82%E8%80%83%E3%80%82&amp;pic=" target="_blank" title="分享到微博" class="btn weibo"><span class="icon icon-weibo"></span></a><a data-toggle="modal" data-target="#modalWechat" title="分享到微信朋友圈" class="btn wechat"><span class="icon icon-wechat"></span></a><a href="https://twitter.com/intent/tweet?text=%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%20CSP%20%E9%83%A8%E7%BD%B2%EF%BC%9ATeambition%20%E5%AE%9E%E6%88%98%20https://www.teambition.com/developer/blog/article%3F_id=5438e83ee903ca681810f174%26p=twitter-share" target="_blank" title="分享到 Twitter" class="btn twitter"><span class="icon icon-twitter"></span></a><a href="http://www.facebook.com/sharer.php?u=https://www.teambition.com/developer/blog/article%3F_id=5438e83ee903ca681810f174%26p=facebook-share&amp;t=%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%20CSP%20%E9%83%A8%E7%BD%B2%EF%BC%9ATeambition%20%E5%AE%9E%E6%88%98" target="_blank" title="分享到 Facebook" class="btn facebook"><span class="icon icon-facebook"></span></a></div></div><div class="tbsite-post-info"><div class="container max730"><div class="infobar clearfix"><span class="author"><span class="avatar img-circle" style="background-image:url('https://file2.teambition.com/site_media/cache/98/8e/3cda1d3e84a40273311ebbe3b96a8e98_250x250.png')" ></span><span class="username">齐俊元</span></span><span class="time">2014-08-04</span></div></div></div><div class="switch-nav"><div class="container max730"><div class="clearfix"><a href="../blog.html" class="gray prev"><span class="icon icon-chevron-left"></span>返回 创作随笔</a></div></div></div></div><div class="modal fade modal-wechat" id="modalWechat" tabindex="-1" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title" id="myModalLabel">分享到微信朋友圈</h4></div><div class="modal-body"><div class="qrcode" data-src="https://www.teambition.com/developer/blog/article?_id=5438e83ee903ca681810f174&p=wechat-share" data-desc="Teambition 对于安全问题一直非常关注，前一阵子@严清老师郑重提出必须即时部署 CSP，然后大家一起认真琢磨了一下，觉得确实是应该在社区中推广的安全策略，特别是 Teambition 的合作伙伴们＝）。下文是严清撰写的实战经验，供大家参考。"></div></div></div></div></div></div><footer class="site-footer hack-webkit-render"><div class="container max1010"><div class="row footer-nav"><div class="col-md-12 clearfix"><ul class="nav-group"><h4>产品</h4><li><a href="../../tour.html" data-gta="event" data-category="out-footer" data-action="product overview">产品概览</a></li><li><a href="../../pricing.html" data-gta="event" data-category="out-footer" data-action="prices">价格</a></li><li><a href="../../apps.html" data-gta="event" data-category="out-footer" data-action="apps">下载</a></li><li><a href="https://bbs.teambition.com" data-gta="event" data-category="out-footer" data-action="community">社区</a></li><li><a href="https://blog.teambition.com/zh/updates" target="_blank" data-gta="event" data-category="out-footer" data-action="updates">最近更新</a></li><li><a href="../../privacy.html" data-gta="event" data-category="out-footer" data-action="privacy">隐私条款</a></li></ul><ul class="nav-group"><h4>公司</h4><li><a href="https://blog.teambition.com/zh/activities" target="_blank" data-gta="event" data-category="out-footer" data-action="news and events">新闻与活动</a></li><li><a href="../../info/team.html" data-gta="event" data-category="out-footer" data-action="team members">团队成员</a></li><li><a href="../../careers.html" target="_blank" data-gta="event" data-category="out-footer" data-action="join us">加入我们</a></li><li><a href="../../info/press.html" data-gta="event" data-category="out-footer" data-action="press release">媒体报道</a></li><li><a href="../../info/partners.html" data-gta="event" data-category="out-footer" data-action="partners">合作伙伴</a></li><li><a href="../../csr.html" data-gta="event" data-category="out-footer" data-action="CSR">公益计划</a></li></ul><ul class="nav-group"><h4>案例</h4><li><a href="../../research/cases.html" data-gta="event" data-category="out-footer" data-action="industry cases">行业案例</a></li><li><a href="../../research/cases/index.html#practices" data-gta="event" data-category="out-footer" data-action="best practice">专题用例</a></li></ul><ul class="nav-group"><h4>开发者</h4><li><a href="../open-source.html" data-gta="event" data-category="out-footer" data-action="open source">开源项目</a></li><li><a href="../open-platform.html" data-gta="event" data-category="out-footer" data-action="developer open-platform">开放平台</a></li><li><a href="../blog.html" data-gta="event" data-category="out-footer" data-action="developer blog">创作随笔</a></li><li><a href="https://help.teambition.com/" data-gta="event" data-category="out-footer" data-action="developer self-test">自助检测</a></li><li><a href="http://status.teambition.net/" data-gta="event" data-category="out-footer" data-action="developer system-status">系统状态</a></li></ul><ul class="nav-group"><h4>联系方式</h4><li><a href="tel:00864000605576">+86 400-060-5576</a><span class="small">周一至周日 8:00 ~ 20:00</span></li><li><a href="mailto:support@teambition.com" data-gta="event" data-category="out-footer" data-action="contact send support email">support@teambition.com</a></li><li><a href="../../info/contactus.html" data-gta="event" data-category="out-footer" data-action="contact us">联系我们</a></li></ul></div></div></div><div class="copyright"><div class="container max1010"><div class="copyandlang text">Copyright © 2013-2016 Teambition<span class="small"><a href="http://www.miitbeian.gov.cn/">沪ICP备11014111号-2</a></span></div><div class="sns-info"><a class="icon icon-wechat"><div class="pop"><label>微信客服</label><p>请扫描二维码</p><div class="qr-wrapper"></div></div></a><a class="icon icon-weibo" href="http://weibo.com/teambition" target="_blank"></a><a class="icon icon-qq"><div class="pop"><label>官方 QQ 群</label><p>群5：475953451</p><p>群6：143032683 (浙江)</p></div></a><a class="icon icon-rss" href="../../../rss.rss" target="_blank"></a><a class="icon icon-dribbble" href="https://dribbble.com/teambition" target="_blank"></a></div></div></div></footer><script id="gta-main" data-google="UA-41231871-1"data-baidu="ec912ecc405ccd050e4cdf452ef4e85a"data-growingio="1b90a59aaa8e4330afbfd547567aa588"></script><script id="global-config" data-env="release"></script><script src="https://dn-st.teambition.net/site/v2.0.0/js/lib.4ec1082b.js"></script><script src="https://dn-st.teambition.net/site/v2.0.0/js/app.00683573.js"></script></body></html>