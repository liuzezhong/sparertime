<!DOCTYPE html><html lang="zh"><head><title>单页面应用的前端多语言处理 - Teambition</title><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="keywords" content="团队协作工具,团队管理工具,项目管理工具,项目协作工具,任务分配,任务进度,文件存储,文件共享,在线预览,知识管理,日程管理,项目管理,项目讨论,项目沟通"><meta name="description" content="Teambition 是一个简单，高效的项目协作工具，你可以在这里管理项目，跟踪任务进度，存储项目文件，让你的团队协作更高效。"><meta property="og:description" content="Teambition 从今年年初开始做国际化，当时的目标是两个季度后能够在中文以外支持英文和日文两个语言，因此团队花了一些时间来尝试一些适合 Single
Page Web
App 的多语言方案。本文是 Teambition 的前端工程师陈涌总结的一篇文章，推荐给每一位希望打造全球化的网页应用的工程师看看＝）"><meta name="viewport" content="initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta name="apple-itunes-app" content="app-id=656664814"/><link rel="alternate" href="../../../site/404.html" hreflang="x-default" /><link rel="shortcut icon" href="../../../favicon.ico"><link rel="stylesheet" href="https://dn-st.teambition.net/site/v2.0.0/css/lib.fc2b25bd.css"><link rel="stylesheet" href="https://dn-st.teambition.net/site/v2.0.0/css/app.f8bcf230.css"></head><body class="page-developer-article tbsite-article zh"><header class="site-header "><div class="container"><nav class="navbar" role="navigation"><div class="navbar-header"><button class="btn btn-primary navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">菜单</button><a class="navbar-brand" href="../../index.html" data-gta="event" data-category="out-top-nav" data-action="tb logo">Teambition・最好用的团队协作工具</a></div><div class="collapse navbar-collapse"><div class="items-wrap"><ul class="navbar-button list-inline"><li class="switch-locale-wrap"><div class="dropdown switch-locale"><a class="dropdown-toggle zh">中文版</a><ul class="dropdown-menu" role="menu" aria-labelledby="dLabel"><li><a href="../../../tw/developer/blog/article-_id=5438e6c6e903ca681810f171.html" class="tw">繁體版</a></li><li><a href="../../../en/developer/blog/article-_id=5438e6c6e903ca681810f171.html" class="en">English</a></li><li><a href="../../../ko/developer/blog/article-_id=5438e6c6e903ca681810f171.html" class="ko">한국어</a></li></ul></div></li><li><a class="btn btn-default btn-sm login" href="https://account.teambition.com/login" data-gta="event" data-category="out-top-nav" data-action="login">登录</a></li><li><a class="btn btn-default btn-sm signup" href="https://account.teambition.com/signup?from=nav" data-gta="event" data-category="out-top-nav" data-action="signup">免费注册</a></li></ul><ul class="nav navbar-nav"><li ><a href="../../tour.html" data-gta="event" data-category="out-top-nav" data-action="tour">功能</a></li><li ><a href="../../pricing.html" data-gta="event" data-category="out-top-nav" data-action="prices">价格</a></li><li ><a href="../../apps.html" data-gta="event" data-category="out-top-nav" data-action="apps">下载</a></li><li><a href="https://bbs.teambition.com" data-gta="event" data-category="out-top-nav" data-action="community">社区</a></li><li><a href="https://blog.teambition.com/zh" data-gta="event" data-category="out-top-nav" data-action="blog">博客</a></li></ul></div></div></nav></div></header><div class="site-main"><div class="article-content"><div class="topbanner not-image"  style="background-color: #494949;"><div class="bg-mask"><div class="container max1010"><div class="return"><a href="../blog.html"><span class="icon icon-chevron-left"></span>返回 创作随笔</a></div><h1 class="title">单页面应用的前端多语言处理</h1></div></div></div><div class="main-content readable"><div class="container max730"><blockquote>
<p><a href="../../../index.html">Teambition</a>从今年年初开始做国际化，当时的目标是两个季度后能够在中文以外支持英文和日文两个语言，因此团队花了一些时间来尝试一些适合 Single
Page Web
App 的多语言方案。本文是 Teambition 的前端工程师陈涌总结的一篇文章，推荐给每一位希望打造全球化的网页应用的工程师看看＝）</p>
</blockquote>
<p>Teambition 的所有产品线都是单页面应用，HTML 在前端渲染因此在需要支持中英文时，多种语言都加载到前端去渲染。在切换到这个方案以前，网页的语言是在服务端跟代码一起进行转换的，下面写的是切换前遇到问题，和切换过程我们采取的方案。</p>
<h2 id="-">切换以前后端渲染的方案</h2>
<p>最开始的方案当中，在开发阶段，代码编译，语言替换，都在服务端通过中间件完成，
当浏览器请求对应的代码时，获取的就是已经编译好的 JavaScript，已经对应的语言
因此模版也是在后端编译的，而多语言的内容，就是通过其中一个 i18n 中间件完成的。</p>
<p>比如，CoffeeScript，doT 源代码当中会有一些这样的内容，用来标记多语言，
这类代码会在发送浏览器前会被处理，编译成对应的中文版或者英文版:</p>
<pre><code>errorMessage = &quot;{{__essageMessage}}&quot;
</code></pre><p>在编译上线的阶段，整个编译过程我们会对两种语言都执行一次，生成两种语言的版本。用户请求应用时，拿到的就是预先编译好，放在 CDN 上的对应语言的代码。</p>
<h2 id="-">后端编译的问题</h2>
<p>开发阶段，服务端编译，因为 Node 本身性能问题，加上应用体积增大，响应的速度变得很慢。
加上前端调试普遍的做法就是改一行代码就刷新一次页面，收到性能的影响就更大了。</p>
<p>除了性能，还有个问题是资源打包，在我们尝试去掉中间件转而用前端工具编程代码的过程中，当语言是通过静态替换强制写入语言的，意味着代码传输到客户端以前，两种语言的源码文件已经存在。于是，上线之前就需要进行两次打包，或者说就是打两份。按上边说的，会有一些性能上的麻烦。</p>
<p>更大的麻烦在于编译过程，因为两种语言的存在，出现了一些意外的复杂问题。
代码上线以前的编译，大致的流程是:</p>
<p>1) CoffeeScript 先转换成 JavaScript，
2) 然后 JavaScript 经过 RequireJS 合并，我们也会留一个环境测试一下合并的代码，
3) 最后代码上线之前，会经过压缩，，最后压缩的代码再上线。</p>
<p>编译过程中间有个调试过程，这个调试过程，基本上需要语言的，也对应刚编译到 JavaScript 这一步。这就需要在编译到 JavaScript 的时候，就是上边的编译过程的第一步，就已经做了多语言。
这之前还要加入一个步骤，把最初的源代码编译出中英文两份。
最终，开发目录就需要用到多个版本的项目代码:</p>
<p>1) 源码
2) 多语言的源码
3) 编译好的开发代码
4) 合并好的代码
5) 压缩准备上线的代码</p>
<p>注意，从 2) 开始，每个源码都需要有中英文两份，
通常整个编译过程写下来，上百行的 Gruntfile 是有了，随着两种语言两倍的代码量，整个更加复杂。
中间还有 RequireJS 之类的问题，受到源码复杂的路径影响，具体这里不展开。
其他还有 LESS，doT，Jade 几种语言的编译，以及相对位置处理，都比较繁琐。。</p>
<h2 id="-">我们的方案</h2>
<p>当然解决方案基本的思路也是从很多已有的项目里学的，就是语言放到前端去渲染。用这个方案，代码编译的过程就不用编译多个版本了，编译过程简化。。
同时修改一行语言，就不用整个 CoffeeScript 文件都编译，只要页面刷新就好了。然后项目当中维护的文件跟着变少了，相对维护多种语言的代码就轻松了很多。</p>
<p>这个方案的思路是，语言文件会被整理成两张 JSON 的表，作为 RequireJS 模块一起打包。
前端代码运行过程中检测浏览器的语言环境，或者写在设置里的语言，
根据这个语言，从表中查询内容，用在页面渲染。比如这样的代码:</p>
<pre><code>lang.getText(&#39;error-message&#39;)
</code></pre><p>当然浏览器当中，模版一旦渲染完成，多语言的内容就应该马上跟上，否则用户看到当成乱码了。
这里可能有两种策略，一种模仿后端，在渲染模版时将语言作为数据传入。
另一种，就是通过 DOM 操作，在模版渲染后通过 jQuery 抓取节点渲染语言。</p>
<p>大致出于两个考虑，我们选择了后一种:</p>
<p>1) 不想在模版引擎中嵌入太多逻辑，而且前端的模版相对后端较弱，频繁插入数据不那么方便，
2) 使用 DOM 操作就有可能在不进行页面刷新的情况下切换语言了，更加灵活</p>
<p>于是为了语言的信息能在前端被 jQuery 正确识别，我们用了这样的代码来标记:</p>
<pre><code>&lt;span data-lang-text=&quot;error-message&quot;&gt;&lt;/span&gt;
</code></pre><p>对这样的代码，我们写了一个 CoffeeScript View 方法，用来对当前 View 的 DOM 进行替换。</p>
<pre><code>renderLocales: -&gt;
  # 获取有 data-lang-* 属性的所有标签
  # 逐个标签读取
  # 取出属性当中的内容作为 key，查询语言
  # 按照 data-lang-* 的语义，替换对应的语言
</code></pre><p>这当中的星号一般是上边的 text，也有可能是 placeholder，甚至 value 或者其他内容。极端的情况还可能是中英文版本的图片，那种情况就特殊问题特殊处理吧。</p>
<p>另一个没有讨论的问题是，DOM 渲染的性能问题，通过属性查询确实不认为是高性能的。这里先不深入，因为实际应用中，这部分操作数量不大，性能方面还不影响用户体验。</p>
<p>到这里，多语言渲染的问题基本完成了。</p>
</div></div><div class="article-toolbar text-center"><div class="share-button-group"><a href="http://service.weibo.com/share/share.php?ralateUid=2673498793&amp;url=https://www.teambition.com/developer/blog/article%3F_id=5438e6c6e903ca681810f171%26p=weibo-share&amp;title=%E3%80%90%E5%8D%95%E9%A1%B5%E9%9D%A2%E5%BA%94%E7%94%A8%E7%9A%84%E5%89%8D%E7%AB%AF%E5%A4%9A%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%91Teambition%20%E4%BB%8E%E4%BB%8A%E5%B9%B4%E5%B9%B4%E5%88%9D%E5%BC%80%E5%A7%8B%E5%81%9A%E5%9B%BD%E9%99%85%E5%8C%96%EF%BC%8C%E5%BD%93%E6%97%B6%E7%9A%84%E7%9B%AE%E6%A0%87%E6%98%AF%E4%B8%A4%E4%B8%AA%E5%AD%A3%E5%BA%A6%E5%90%8E%E8%83%BD%E5%A4%9F%E5%9C%A8%E4%B8%AD%E6%96%87%E4%BB%A5%E5%A4%96%E6%94%AF%E6%8C%81%E8%8B%B1%E6%96%87%E5%92%8C%E6%97%A5%E6%96%87%E4%B8%A4%E4%B8%AA%E8%AF%AD%E8%A8%80%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%9B%A2%E9%98%9F%E8%8A%B1%E4%BA%86%E4%B8%80%E4%BA%9B%E6%97%B6%E9%97%B4%E6%9D%A5%E5%B0%9D%E8%AF%95%E4%B8%80%E4%BA%9B%E9%80%82%E5%90%88%20Single%0D" target="_blank" title="分享到微博" class="btn weibo"><span class="icon icon-weibo"></span></a><a data-toggle="modal" data-target="#modalWechat" title="分享到微信朋友圈" class="btn wechat"><span class="icon icon-wechat"></span></a><a href="https://twitter.com/intent/tweet?text=%E5%8D%95%E9%A1%B5%E9%9D%A2%E5%BA%94%E7%94%A8%E7%9A%84%E5%89%8D%E7%AB%AF%E5%A4%9A%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%20https://www.teambition.com/developer/blog/article%3F_id=5438e6c6e903ca681810f171%26p=twitter-share" target="_blank" title="分享到 Twitter" class="btn twitter"><span class="icon icon-twitter"></span></a><a href="http://www.facebook.com/sharer.php?u=https://www.teambition.com/developer/blog/article%3F_id=5438e6c6e903ca681810f171%26p=facebook-share&amp;t=%E5%8D%95%E9%A1%B5%E9%9D%A2%E5%BA%94%E7%94%A8%E7%9A%84%E5%89%8D%E7%AB%AF%E5%A4%9A%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86" target="_blank" title="分享到 Facebook" class="btn facebook"><span class="icon icon-facebook"></span></a></div></div><div class="tbsite-post-info"><div class="container max730"><div class="infobar clearfix"><span class="author"><span class="avatar img-circle" style="background-image:url('https://file2.teambition.com/site_media/cache/98/8e/3cda1d3e84a40273311ebbe3b96a8e98_250x250.png')" ></span><span class="username">齐俊元</span></span><span class="time">2014-06-30</span></div></div></div><div class="switch-nav"><div class="container max730"><div class="clearfix"><a href="../blog.html" class="gray prev"><span class="icon icon-chevron-left"></span>返回 创作随笔</a></div></div></div></div><div class="modal fade modal-wechat" id="modalWechat" tabindex="-1" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title" id="myModalLabel">分享到微信朋友圈</h4></div><div class="modal-body"><div class="qrcode" data-src="https://www.teambition.com/developer/blog/article?_id=5438e6c6e903ca681810f171&p=wechat-share" data-desc="Teambition 从今年年初开始做国际化，当时的目标是两个季度后能够在中文以外支持英文和日文两个语言，因此团队花了一些时间来尝试一些适合 Single
Page Web
App 的多语言方案。本文是 Teambition 的前端工程师陈涌总结的一篇文章，推荐给每一位希望打造全球化的网页应用的工程师看看＝）"></div></div></div></div></div></div><footer class="site-footer hack-webkit-render"><div class="container max1010"><div class="row footer-nav"><div class="col-md-12 clearfix"><ul class="nav-group"><h4>产品</h4><li><a href="../../tour.html" data-gta="event" data-category="out-footer" data-action="product overview">产品概览</a></li><li><a href="../../pricing.html" data-gta="event" data-category="out-footer" data-action="prices">价格</a></li><li><a href="../../apps.html" data-gta="event" data-category="out-footer" data-action="apps">下载</a></li><li><a href="https://bbs.teambition.com" data-gta="event" data-category="out-footer" data-action="community">社区</a></li><li><a href="https://blog.teambition.com/zh/updates" target="_blank" data-gta="event" data-category="out-footer" data-action="updates">最近更新</a></li><li><a href="../../privacy.html" data-gta="event" data-category="out-footer" data-action="privacy">隐私条款</a></li></ul><ul class="nav-group"><h4>公司</h4><li><a href="https://blog.teambition.com/zh/activities" target="_blank" data-gta="event" data-category="out-footer" data-action="news and events">新闻与活动</a></li><li><a href="../../info/team.html" data-gta="event" data-category="out-footer" data-action="team members">团队成员</a></li><li><a href="../../careers.html" target="_blank" data-gta="event" data-category="out-footer" data-action="join us">加入我们</a></li><li><a href="../../info/press.html" data-gta="event" data-category="out-footer" data-action="press release">媒体报道</a></li><li><a href="../../info/partners.html" data-gta="event" data-category="out-footer" data-action="partners">合作伙伴</a></li><li><a href="../../csr.html" data-gta="event" data-category="out-footer" data-action="CSR">公益计划</a></li></ul><ul class="nav-group"><h4>案例</h4><li><a href="../../research/cases.html" data-gta="event" data-category="out-footer" data-action="industry cases">行业案例</a></li><li><a href="../../research/cases/index.html#practices" data-gta="event" data-category="out-footer" data-action="best practice">专题用例</a></li></ul><ul class="nav-group"><h4>开发者</h4><li><a href="../open-source.html" data-gta="event" data-category="out-footer" data-action="open source">开源项目</a></li><li><a href="../open-platform.html" data-gta="event" data-category="out-footer" data-action="developer open-platform">开放平台</a></li><li><a href="../blog.html" data-gta="event" data-category="out-footer" data-action="developer blog">创作随笔</a></li><li><a href="https://help.teambition.com/" data-gta="event" data-category="out-footer" data-action="developer self-test">自助检测</a></li><li><a href="http://status.teambition.net/" data-gta="event" data-category="out-footer" data-action="developer system-status">系统状态</a></li></ul><ul class="nav-group"><h4>联系方式</h4><li><a href="tel:00864000605576">+86 400-060-5576</a><span class="small">周一至周日 8:00 ~ 20:00</span></li><li><a href="mailto:support@teambition.com" data-gta="event" data-category="out-footer" data-action="contact send support email">support@teambition.com</a></li><li><a href="../../info/contactus.html" data-gta="event" data-category="out-footer" data-action="contact us">联系我们</a></li></ul></div></div></div><div class="copyright"><div class="container max1010"><div class="copyandlang text">Copyright © 2013-2016 Teambition<span class="small"><a href="http://www.miitbeian.gov.cn/">沪ICP备11014111号-2</a></span></div><div class="sns-info"><a class="icon icon-wechat"><div class="pop"><label>微信客服</label><p>请扫描二维码</p><div class="qr-wrapper"></div></div></a><a class="icon icon-weibo" href="http://weibo.com/teambition" target="_blank"></a><a class="icon icon-qq"><div class="pop"><label>官方 QQ 群</label><p>群5：475953451</p><p>群6：143032683 (浙江)</p></div></a><a class="icon icon-rss" href="../../../rss.rss" target="_blank"></a><a class="icon icon-dribbble" href="https://dribbble.com/teambition" target="_blank"></a></div></div></div></footer><script id="gta-main" data-google="UA-41231871-1"data-baidu="ec912ecc405ccd050e4cdf452ef4e85a"data-growingio="1b90a59aaa8e4330afbfd547567aa588"></script><script id="global-config" data-env="release"></script><script src="https://dn-st.teambition.net/site/v2.0.0/js/lib.4ec1082b.js"></script><script src="https://dn-st.teambition.net/site/v2.0.0/js/app.00683573.js"></script></body></html>